<!DOCTYPE html>
<html lang="en">
<head>
    <title>GTM Test Page</title>
    <meta charset="UTF-8">
    <script>
        let messagePort = null;
        
        // Set up debug API interface for Tag Assistant
        window.debugBadgeApi = {
            setReceiver: function(receiver) {
                // Store the receiver function
                window._gtmDebugReceiver = receiver;
            },
            sendMessage: function(message) {
                // Forward debug messages to iframe through MessageChannel
                if (messagePort && message.messageType === 'CONTAINER_DEBUG') {
                    messagePort.postMessage({
                        type: 'GTM_DEBUG',
                        data: message
                    });
                }
            }
        };

        // Listen for initial channel setup from iframe
        window.addEventListener('message', function(event) {
            // Log the received message for debugging
            console.log('Received message from:', event.origin);
        
            // Accept messages from our GitHub Pages domain or its subpaths
            if (!event.origin.startsWith('https://richpoirier.github.io')) {
                console.warn('Received message from unexpected origin:', event.origin);
                return;
            }

            // Handle the MessageChannel port transfer
            if (event.data === 'INIT_CHANNEL') {
                messagePort = event.ports[0];
                
                // Listen for messages on the port
                messagePort.onmessage = function(e) {
                    if (e.data && e.data.type === 'GTM_DATA') {
                        const gtmData = e.data.data;
                        
                        // Create a proxy object that Tag Assistant can detect
                        if (gtmData.hasGTM && !window.google_tag_manager) {
                            // Create dataLayer if it doesn't exist
                            window.dataLayer = window.dataLayer || [];
                            
                            // Sync dataLayer from iframe
                            if (gtmData.dataLayer) {
                                window.dataLayer.push(...gtmData.dataLayer);
                            }
                            
                            // Create google_tag_manager proxy
                            window.google_tag_manager = {};
                            if (gtmData.containerId) {
                                window.google_tag_manager[gtmData.containerId] = {
                                    dataLayer: window.dataLayer,
                                    _debugFlag: true,
                                    debug: {
                                        state: 'loaded',
                                        dataLayer: window.dataLayer,
                                        // Add proxy methods for debug functionality
                                        sendDebugData: function(data) {
                                            messagePort.postMessage({
                                                type: 'GTM_DEBUG_DATA',
                                                data: data
                                            });
                                        }
                                    }
                                };
                            }
                            
                            console.log('GTM data synced from iframe:', window.google_tag_manager);
                        }
                    } else if (e.data && e.data.type === 'GTM_DEBUG_EVENT') {
                        // Forward debug events to Tag Assistant
                        if (window._gtmDebugReceiver) {
                            window._gtmDebugReceiver(e.data.data);
                        }
                    }
                };

                // Start receiving messages
                messagePort.start();
            }
        });
    </script>
    <!-- Ensure proper Content-Security-Policy -->
    <meta http-equiv="Content-Security-Policy" content="frame-src https://richpoirier.github.io https://www.googletagmanager.com">
</head>
<body>
    <h1>GTM Test Page</h1>
    <iframe 
        sandbox="allow-scripts allow-forms" 
        src="https://richpoirier.github.io/iframe-test/iframe.html"
        title="Web Pixel"
        style="width:0;height:0;border:0;visibility:hidden"
    ></iframe>
</body>
</html>