<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Web Pixel</title>
        <script>
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-T36KSSBM');
            
            // Function to check GTM and send data to parent
            function checkAndSendGTMData() {
                // Check if GTM is loaded
                if (window.google_tag_manager) {
                    const containerId = Object.keys(window.google_tag_manager)[0];
                    
                    // Create a minimal safe copy of GTM state
                    const safeGTMState = {
                        'gtm.start': window.dataLayer?.[0]?.['gtm.start'],
                        loaded: true,
                        version: window.google_tag_manager[containerId]?.version || '',
                    };

                    // Create a safe copy of dataLayer with only essential data
                    const safeDataLayer = window.dataLayer ? window.dataLayer.map(item => {
                        if (item && typeof item === 'object') {
                            // Only include essential GTM events and properties
                            const safeItem = {};
                            if (item.event) safeItem.event = item.event;
                            if (item['gtm.start']) safeItem['gtm.start'] = item['gtm.start'];
                            if (item['gtm.uniqueEventId']) safeItem['gtm.uniqueEventId'] = item['gtm.uniqueEventId'];
                            return safeItem;
                        }
                        return item;
                    }).filter(Boolean) : [];

                    window.parent.postMessage({
                        type: 'GTM_DATA',
                        data: {
                            hasGTM: true,
                            containerId,
                            dataLayer: safeDataLayer,
                            gtmState: safeGTMState
                        }
                    }, '*');
                    return true;
                }
                return false;
            }
        
            // Try immediately
            if (!checkAndSendGTMData()) {
                // If GTM not loaded yet, check periodically
                const checkInterval = setInterval(() => {
                    if (checkAndSendGTMData()) {
                        clearInterval(checkInterval);
                    }
                }, 500);
        
                // Stop checking after 10 seconds
                setTimeout(() => clearInterval(checkInterval), 10000);
            }
        </script>
    </head>
    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript>
            <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T36KSSBM" height="0" width="0" style="display:none;visibility:hidden"></iframe>
        </noscript>
        <!-- End Google Tag Manager (noscript) -->
        <h1>Iframe Test</h1>
    </body>
</html>